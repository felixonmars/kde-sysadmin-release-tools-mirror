# This is a helper script, which removes the useless stuff from some modules.
# For instance it separates the koffice translations between kde-i18n and koffice-i18n.
# Call it with the package name as argument, like:  ./removestuff kde-i18n
# Usually, you'll want to do this before tagging.

package=$1
version=$2

CDPATH=""

test -n "$package" || { echo "requires modulename as parameter"; exit 1; }

cd_package()
{
  if test -n "$version" && test -d $package-$version; then
    cd $package-$version
  else
    cd $package || { echo "bah! $package doesn't exist in $PWD"; exit 1; }
  fi
}

# Unlike "pack", this script acts on clean/, because it's supposed to be run
# before tagging.
# but it can also act in dirty, for packaging

  if [ $package = "koffice-i18n" ]; then
  (
     cd_package
     echo "Removing non-koffice stuff"
     perl -pi -e 's/kde-i18n/koffice-i18n/g; s/kdelibs.po/Makefile.am/g' Makefile.am
     rm -rf templates
     if grep -E -q '[a-z] +$' subdirs; then
       echo "subdirs has a trailing space on a line! This breaks stuff, fix it."
       exit 1
     fi
     cp subdirs subdirs.new
     cat subdirs | while read lang; do
       (
         found=""
         test -d $lang && {
         cd $lang
         # Look for koffice stuff in subdirs
         for subdir in data messages docs; do
           subdirlist=""
           if test -d $subdir/koffice; then
             subdirlist="$subdirlist $subdir/koffice"
           fi
           if test -d $subdir/docs/koffice; then
             subdirlist="$subdirlist $subdir/docs/koffice"
           fi
           if test -n "$subdirlist"; then
             mv $subdir $subdir.orig &&
             mkdir $subdir &&
             mv $subdir.orig/Makefile.am $subdir/ &&
             mv $subdir.orig/CVS $subdir/ || exit 1
             mv $subdir.orig/.cvsignore $subdir/ 2>/dev/null
             for s in `echo $subdirlist`; do
               orig=`echo $s | sed -e "s/^$subdir/$subdir.orig/"`
               # This is for e.g. messages/docs/koffice, we need to create messages/docs first
               parent=`echo $s | sed -e 's,/[^/]*$,,'`
               mkdir -p $parent &&
                   mv $orig $s || exit 1
             done
             rm -rf $subdir.orig || exit 1
             found="$found $subdirlist"
           else
             rm -rf $subdir
           fi
         done
         cd ..
         }
         if test -z "$found"; then
           echo "$lang has no koffice translation, removing"
           rm -rf $lang
           sed -e "/^$lang/d" subdirs.new > subdirs.tmpnew
           mv -f subdirs.tmpnew subdirs.new
         else
           echo "$lang: found$found"
         fi
       )
     done
     mv -f subdirs.new subdirs
  ) || exit 1
  fi

  if [ $package = "kde-i18n" ]; then
  (  
     cd_package
     echo "Removing other stuff"
     cat subdirs | while read lang; do
       ( cd $lang  && \
	 rm -rf messages/kdesdk/kdevelop.po && \
	 rm -rf docs/kdevelop && \
	 rm -rf messages/others && \
         rm -rf docs/others && \
         rm -rf messages/docs/others && \
         rm -rf messages/kdenonbeta && \
         rm -rf docs/kdenonbeta && \
         rm -rf messages/docs/kdenonbeta && \
         rm -rf messages/kdeextragear-[1-9] && \
         rm -rf docs/kdeextragear-[1-9] && \
         rm -rf messages/docs/kdeextragear-[1-9] && \
         rm -rf messages/kdekiosk && \
         rm -rf docs/kdekiosk && \
         rm -rf messages/docs/kdekiosk )
     done
     echo "Removing template specific stuff"
     rm -rf templates
     echo "Removing koffice specific stuff"
     cat subdirs | while read lang; do
       ( cd $lang  && \
         rm -rf */koffice \
         rm -rf messages/docs/koffice )
     done
  )
  fi

  if [ $package = "kde-i18n" -o $package = "koffice-i18n" ]; then
  ( 
    cd_package 
    echo Removing non-released languages from package
    test -f subdirs.orig || { echo "$package/subdirs.orig doesn't exist"; exit 1; }
    grep ^xx subdirs && { echo "$package/subdirs contains the xx language!"; exit 1; }
    cat subdirs.orig | while read lang; do
       if grep -q ^$lang\$ subdirs; then
          echo Keeping $lang
       else
          echo Deleting $lang
          rm -rf $lang
       fi
    done
    ) || exit 1
  fi

  if [ $package = "koffice" ]; then
  (  
     cd_package
     echo "Removing non-released stuff"
     rm -rf krita kdatabase kplato graphite kexi kdgantt
  )
  fi

  # generic stuff
  (
     cd_package
     echo "removing Makefile.cvs"
     rm -f Makefile.cvs
  )

