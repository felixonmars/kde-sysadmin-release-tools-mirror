# This is a helper script, which removes the useless stuff from some modules.
# For instance it separates the koffice translations between kde-l10n and koffice-l10n.
# Call it with the package name as argument, like:  ./removestuff kde-l10n

# This is called by tag_all with DO_SVN=1 in order to remove unused stuff from a tag.

source `dirname $0`/common $1 $2

# If last element in a path contains @-character, svn may interpret it as
# a revision number separator, depending on command and argument position.
# This can be escaped by adding one trailing @ to such paths.
# svn rm: all path arguments sensitive to @
svn_rm () {
    paths_esc=
    for rawpath in "$@"; do paths_esc="$paths_esc '$rawpath@'"; done
    eval "svn rm $paths_esc"
}

rm_command="rm -rf"
if test -n "$DO_SVN"; then
  rm_command=svn_rm
fi

cd_package()
{
  if test -n "$version" && test -d $package-$version; then
    cd $package-$version
  else
    cd $package || { echo "bah! $package doesn't exist in $PWD"; exit 1; }
  fi
}

  if [ $package = "koffice-l10n" ]; then
  (
     # Most of this is redundant if you use the koffice-l10n script.
     # However, the removing kdgantt.po part is necessary, and the rest is
     # harmless.
     cd_package
     echo "Removing non-koffice stuff"
     $rm_command templates
     if grep -E -q '[a-z] +$' subdirs; then
       echo "subdirs has a trailing space on a line! This breaks stuff, fix it."
       exit 1
     fi
     cat subdirs | while read lang; do
       cd $lang || continue
       echo $lang
       $rm_command internal
       $rm_command docmessages
       $rm_command webmessages
       test -f messages/koffice/kdgantt.po && $rm_command messages/koffice/kdgantt.po
       for sub in messages docs data; do
         test -d $sub || continue
         cd $sub
         for i in *; do
           test $i != "koffice" -a $i != "Makefile.am" && $rm_command $i
         done
         cd ..
         files=`ls -1 $sub | wc -l`
         test $files -eq 0 && $rm_command $sub
       done
       cd ..
     done
     echo "Removing template specific stuff"
     $rm_command templates
     $rm_command debian || true
  ) || exit 1
  fi

  if [ $package = "kde-l10n" -o $package = "kde-i18n" ]; then
  (
     cd_package
     echo "Removing other stuff"
     cat subdirs | while read lang; do
       cd $lang || continue
       $rm_command internal 
       $rm_command docmessages 
       $rm_command webmessages 
       $rm_command messages/*/desktop_* 
       $rm_command messages/others 
       $rm_command messages/index.lokalize
       $rm_command docs/others 
       $rm_command messages/kdenonbeta 
       $rm_command docs/kdenonbeta 
       $rm_command messages/extragear-*
       $rm_command messages/playground-*
       $rm_command messages/no-auto-merge
       $rm_command docs/extragear-* 
       $rm_command docs/playground-*
       $rm_command messages/kdekiosk
       $rm_command docs/kdekiosk 
       $rm_command messages/play* 
       $rm_command messages/kdereview 
       $rm_command */koffice 
       $rm_command messages/kdevelop
       $rm_command docs/kdevelop
       $rm_command messages/kdevplatform
       $rm_command docs/kdevplatform
       $rm_command docs/kdewebdev/quanta*
       $rm_command messages/kdewebdev/quanta*
       $rm_command no-auto-merge
       $rm_command */no-auto-merge

#       $rm_command messages/kdenetwork/kopete*
#       $rm_command docs/kdenetwork/kopete*
#       test -d docs/common || {
#            echo "$lang/docs/common not translated, removing" 
#            $rm_command docs 
#       }
       cd ..
     done
     echo "Removing template specific stuff"
     $rm_command templates
  )
  fi

  if [ $package = "kde-l10n" -o $package = "koffice-l10n" -o $package = "kde-i18n" ]; then
  (
    cd_package

    echo Moving language variants to be packed together
    for dir in *; do
      if test -f $dir/pack-with-variants; then
        cat $dir/pack-with-variants | while read vdir; do
          echo Moving $vdir into $dir
          mv $vdir $dir
        done
        $rm_command $dir/pack-with-variants
      fi
    done

    echo Removing non-released languages from package
    grep ^xx subdirs && { echo "$package/subdirs contains the xx language!"; exit 1; }
    for dir in *; do
	if test -d $dir/messages -o -d $dir/docs; then
            if grep -q ^$dir\$ subdirs; then
                 echo Keeping $dir
            else
                 echo Deleting $dir
                 $rm_command $dir
	    fi
        fi

        # For KOffice, some languages directories may be entirely empty
        # by this point.
        if test -d $dir ; then
          files=`ls -1 $dir | wc -l`
          test $files -eq 0 && $rm_command $dir
        fi

    done
    ) || exit 1
  fi

  if [ $package = "koffice" ]; then
  (
     cd_package
#     $rm_command kexi
     $rm_command kivio
     $rm_command tools/f-office
     echo "Removing non-released stuff"
  )
  fi

  if [ $package = "kdenetwork" ]; then
  (
     cd_package
#     $rm_command kopete
#     $rm_command doc/kopete
#     echo "Removing kopete from kdenetwork"
  )
  fi

  if test -z "$DO_SVN"; then
    if [ $package = "kdebase" ]; then
    (
       cd_package
       $rm_command workspace
       $rm_command runtime
       echo "Removing workspace/runtime from kdebase"
    )
    fi

    if [ $package = "kdebase-workspace" ]; then
    (
       cd_package
       $rm_command runtime
       $rm_command apps
       echo "Removing runtime,apps from kdebase-workspace"
    )
    fi

    if [ $package = "kdelibs" ]; then
    (
       cd_package
       $rm_command experimental
       echo "Removing experimental from kdelibs"
    )
    fi

    if [ $package = "kdepim" ]; then
    (
       cd_package
       $rm_command akonadi
       echo "Removing akonadi from kdepim"
    )
    fi
  fi

  if [ $package = "kdewebdev" ]; then
  (
     cd_package
     $rm_command quanta
     echo "Removing quanta from kdewebdev"
  )
  fi

  # generic stuff
  (
     cd_package
     rm -f svn-commit*.*
  )

