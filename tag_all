#!/bin/bash

tagdir=tagging.$$

BASE=svn+ssh://coolo@svn.kde.org/home/kde

function co_subdir {
	echo co_subdir $1
	if test ! -d $tagdir/$1; then
		co_subdir `dirname $1`
		svn up -N $tagdir/$1
	fi
}

function set_urls {
case $1 in
  arts)
    HEADURL=branches/arts/1.4/$i
    DESTURL=tags/arts/1.4.1/$i
    subname=$1
    ;;
  kde-l10n)
    HEADURL=branches/stable/l10n
    DESTURL=tags/KDE/3.4.1/kde-i18n
    subname=kde-i18n
    ;;
  *)
    HEADURL=branches/KDE/3.4/$i
    DESTURL=tags/KDE/3.4.1/$i
    subname=$1
    ;;
esac

}

function replace_exts {
svn pg svn:externals $1 | while read subdir url; do
   test -n "$url" || continue
   rm -rf $1/$subdir
   svn copy ${url/https:\/\//svn+ssh://coolo@} $1/$subdir
done
svn pd svn:externals $1
}

if test -z "$ONLY_CLEANUP"; then
  svn co -N $BASE $tagdir
  co_subdir tags
fi

for i in `cat modules`; do

(
test -z "$ONLY_CLEANUP" || continue

set_urls $i

co_subdir `dirname $HEADURL`
tt=`dirname $DESTURL`
tt2=`dirname $tt`
if ! test -d $tagdir/$tt; then
   svn up -N $tagdir/$tt2
   svn mkdir $tagdir/$tt
fi
svn up -N $tagdir/$HEADURL
if test "$i" = "kde-l10n"; then
  svn up -N $tagdir/$HEADURL/scripts
fi
svn copy $tagdir/$HEADURL $tagdir/$DESTURL
replace_exts $tagdir/$DESTURL

)
done
if test -z "$ONLY_CLEANUP"; then
  set_urls kde-l10n
  cp language_list $tagdir/$DESTURL/subdirs
  replace_exts $tagdir/$DESTURL/scripts
  svn commit $tagdir || exit 1
  rm -rf $tagdir
fi

cd clean
for i in `cat ../modules`; do
  set_urls $i
  if test -d $i; then 
	svn switch $BASE/$DESTURL $subname
  else
        svn co $BASE/$DESTURL $subname
  fi
  DO_SVN=1 ../removestuff $i
done

